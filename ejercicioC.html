<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reconocimiento de Objetos</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.1.9/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@0.5.0/dist/ml5.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f0f0f0;
      margin: 20px;
    }
    #referencias div {
      display: inline-block;
      margin: 5px;
    }
    #referencias img {
      width: 60px;
      height: 60px;
      margin: 5px;
    }
    #canvasContainer {
      margin-top: 15px;
    }
    button {
      margin-top: 10px;
      padding: 8px 14px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2>Reconocimiento de Objetos</h2>

  <!-- Formulario-->
  <div id="referencias">
    <div><img src="images/celular.jpg" alt="celular"><br>Celular</div>
    <div><img src="images/billetera.jpg" alt="bolletera"><br>Billetera</div>
    <div><img src="images/cargador.jpg" alt="cargador"><br>Cargador</div>
    <div><img src="images/llaves.jpg" alt="llave"><br>Llave</div>
    <div><img src="images/tomatodo.jpg" alt="tomatodo"><br>Tomatodo</div>
  </div>

  <button id="btnSonido">Desactivar Sonido</button>
  <div id="canvasContainer"></div>

  <script>
    let classifier;
    const imageModelURL = './models/'; // Ruta de tu modelo
    let video;
    let flippedVideo;
    let label = "";
    let ultimoLabel = "";
    let sonidoActivo = true;

    const objetosValidos = ["celular","billetera","cargador","llave","tomatodo"];

    function preload() {
      classifier = ml5.imageClassifier(imageModelURL + 'model.json'); // Cargar modelo
    }

    function setup() {
      // Crear canvas
      let canvas = createCanvas(320, 260);
      canvas.parent('canvasContainer');

      // Captura de video
      video = createCapture(VIDEO);
      video.size(320, 240);
      video.hide();

      flippedVideo = ml5.flipImage(video);
      classifyVideo();

      // BotÃ³n de sonido
      document.getElementById('btnSonido').addEventListener('click', () => {
        sonidoActivo = !sonidoActivo;
        document.getElementById('btnSonido').textContent = sonidoActivo ? 'Desactivar Sonido' : 'Activar Sonido';
        if (!sonidoActivo) speechSynthesis.cancel();
      });
    }

    //Muestra el video
    function draw() {
      background(0);
      image(flippedVideo, 0, 0);
      fill(255);
      textSize(18);
      textAlign(CENTER);
      text(label, width/2, height-10);
    }

    function classifyVideo() {
      flippedVideo = ml5.flipImage(video);
      classifier.classify(flippedVideo, gotResult);
      flippedVideo.remove();
    }

    function gotResult(error, results) {
      if(error) { console.error(error); return; }

      let nuevoLabel = results[0].label.toLowerCase();

      if(nuevoLabel !== ultimoLabel && objetosValidos.includes(nuevoLabel)) {
        label = nuevoLabel; // Actualizar etiqueta
        if(sonidoActivo) hablar(label);
        ultimoLabel = label;
      } else {
        label = nuevoLabel;
      }

      classifyVideo();
    }

    function hablar(texto) {
      let utter = new SpeechSynthesisUtterance(texto);
      utter.lang = 'es-ES';
      speechSynthesis.speak(utter); // Reproducir voz
    }
  </script>

</body>
</html>
