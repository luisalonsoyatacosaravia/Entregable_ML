<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reconocimiento de Objetos</title>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.1.9/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@0.5.0/dist/ml5.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      background: #f0f0f0;
      margin: 20px;
    }
    #referencias div {
      display: inline-block;
      margin: 5px;
    }
    #referencias img {
      width: 60px;
      height: 60px;
      margin: 5px;
    }
    #canvasContainer {
      margin-top: 15px;
    }
    button {
      margin-top: 10px;
      padding: 8px 14px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <h2>Reconocimiento de Objetos</h2>

  <!-- Formulario-->
  <div id="referencias">
    <div><img src="images/celular.jpg" alt="celular"><br>Celular</div>
    <div><img src="images/billetera.jpg" alt="billetera"><br>Billetera</div>
    <div><img src="images/cargador.jpg" alt="cargador"><br>Cargador</div>
    <div><img src="images/llaves.jpg" alt="llave"><br>Llave</div>
    <div><img src="images/mouse.jpg" alt="mouse"><br>Mouse</div>
  </div>

  <button id="btnSonido">Desactivar Sonido</button>
  <button id="btnRegresar">Regresar</button>
  <div id="canvasContainer"></div>

<script>
  let classifier;       // Clasificador del modelo ML5                   
  const imageModelURL = './models/';
  let video;
  let flippedVideo;
  let label = "";
  let ultimoLabel = "";
  let sonidoActivo = true;
  let ultimaVoz = 0;
  const tiempoMinimoEntreVoces = 3000; 
  let deteccionEstable = 0; // tiempo acumulado del mismo objeto


  const objetosValidos = ["celular", "billetera", "cargador", "llave", "mouse"];

  function preload() {
    classifier = ml5.imageClassifier(imageModelURL + 'model.json');
  }

  
 function setup() {
  //Creación del botón Regresar
    document.getElementById('btnRegresar').addEventListener('click', () => {
    window.location.href = 'index.html';
  });
    
    let canvas = createCanvas(320, 260);
    canvas.parent('canvasContainer');

    video = createCapture(VIDEO);
    video.size(320, 240);
    video.hide();

    flippedVideo = ml5.flipImage(video);

    // Llama a la función
    classifyVideo();

    document.getElementById('btnSonido').addEventListener('click', () => {
      sonidoActivo = !sonidoActivo;
      document.getElementById('btnSonido').textContent = sonidoActivo ? 'Desactivar Sonido' : 'Activar Sonido';
      if (!sonidoActivo) speechSynthesis.cancel();
    });
  }

  function draw() {
    background(0);
    image(flippedVideo, 0, 0); // Muestra el video en el canvas
    fill(255);
    textSize(18);
    textAlign(CENTER);
    text(label, width/2, height-10);
  }

  function classifyVideo() {
    flippedVideo = ml5.flipImage(video);
    classifier.classify(flippedVideo, gotResult);
    flippedVideo.remove();
  }

  function gotResult(error, results) {
    if (error) { console.error(error); return; }

    let nuevoLabel = results[0].label.toLowerCase().trim();
    console.log("Detectado:", nuevoLabel); //ver qué detecta realmente

    let ahora = millis();

    // Verifica si el resultado pertenece a los objetos válidos
    if (objetosValidos.some(o => nuevoLabel.includes(o))) {
      label = nuevoLabel;

      // Cuando el objeto este estable , la voz se activa y habla
      if (nuevoLabel === ultimoLabel) {
        deteccionEstable += deltaTime;
        if (deteccionEstable > 1000 && sonidoActivo && (ahora - ultimaVoz > tiempoMinimoEntreVoces)) {
          hablar(label);
          ultimaVoz = ahora;
          deteccionEstable = 0;
        }
      } else {
        deteccionEstable = 0;
      }

      ultimoLabel = nuevoLabel;
    } else {
      label = "";
      deteccionEstable = 0;
    }

    classifyVideo();
  }

  function hablar(texto) {
    if (speechSynthesis.speaking) speechSynthesis.cancel();
    let utter = new SpeechSynthesisUtterance(texto);
    utter.lang = 'es-ES';
    speechSynthesis.speak(utter);
  }
</script>


</body>
</html>
